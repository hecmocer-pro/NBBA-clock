<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NBBA Clock</title>
</head>
<body>

  <style>
    body {
      margin: 0;
    }

    .page[hidden], .delay-container[hidden], .pause-turn-container[hidden] {
      display: none;
    }

    .page {
      display: flex;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      justify-content: center;
      align-items: center;
      position: absolute;
    }

    .page1-form {
      display: flex;
      flex-direction: column;
    }

    .page1-form-group {
      margin: 8px 0;
      display: flex;
      flex-direction: column;
    }

    .team-turn {
      width: 50vw;
      height: 100vh;
      position: absolute;

      display: flex;
      flex-direction: column;
      justify-content: space-around;
      align-items: center;

      border: solid 1px black;
      background: #000;
      padding: 0;

      z-index: 5;
    }

    .team-turn:nth-of-type(1) {
      left: 0;
      top: 0;
    }

    .team-turn:nth-of-type(2) {
      left: 50vw;
      top: 0;
    }

    .pause-turn-container {
      width: 100vw;
      display: flex;
      justify-content: center;
      position: absolute;
      bottom: 0;
    }

    .pause-turn {
      width: 200px;
      height: 200px;
      z-index: 15;
    }

    .team-logo {
      position: absolute;
    }

    .team1-turn .team-logo {
      transform: skew(0deg, -20deg);
    }

    .team2-turn .team-logo {
      transform: skew(0deg, 20deg);
    }

    .team-turn-content, .score, .team-turn-turn {
      color: white;
      font-size: 64px;
      z-index: 5;
    }

    .team-turn-content {
      display: flex;
      flex-direction: column;
      justify-content: center;
      height: 100%;
      width: 100%;
      background: rgba(0,0,0,0.4);
    }

    .team-turn-turn {
      position: absolute;
      bottom: 0;
    }

    .score {
      position: absolute;
      top: 0;
      z-index: 10;
      pointer-events: none;
      width: 100%;

      display: flex;
      justify-content: center;
    }

    .score div:nth-child(1), .score div:nth-child(3) {
      width: 45%;
    }

    .pause-turn {

    }

    .team-score-name {
      width: 40%;
    }

    .team1-score-name {
      text-align: right;
    }

    .teams-scoreboard {
      width: 20%;
      text-align: center;
    }

    .page3 {
      z-index: 20;
      background: #eeeeee66;
      display: flex;
      justify-content: space-evenly;
      align-items: center;
      flex-direction: column;
    }

    .team-turn-time {
      font-size: 80px;
      background: rgba(0,0,0,0.8)
    }

    .delay-container {
      display: flex;
      justify-content: center;
      align-items: center;
      position: absolute;
      z-index: 35;
      width: 100%;
      height: 100%;
      background-color: #ffffff44;
    }
    .delay {
      color: #fff;
      font-size: 64px;
    }

    .paused {
      font-size: 80px;
      color: white;
    }

    .teams-score {
      display: flex;
      flex-direction: column;
      color: #fff;
      font-size: 32px;
    }
  </style>

  <div class="page page1" id="page1" hidden>
    <form id="form" class="page1-form" action="">
      <div class="page1-form-group">
        <label for="team1">Equipo 1 — local</label>
        <select name="team1" id="team1" required>
          <option value="0">N/A</option>
          <option value="1">Orkadianoz</option>
          <option value="2">Koalaz</option>
          <option value="3">Equipo 3</option>
          <option value="4">Equipo 4</option>
          <option value="5">Equipo 5</option>
          <option value="6">Equipo 6</option>
          <option value="7">Equipo 7</option>
          <option value="8">Equipo 8</option>
        </select>
      </div>
      <div class="page1-form-group">
        <label for="team2">Equipo 2 — visitante</label>
        <select name="team2" id="team2" required>
          <option value="0">N/A</option>
          <option value="1">Orkadianoz</option>
          <option value="2">Koalaz</option>
          <option value="3">Equipo 3</option>
          <option value="4">Equipo 4</option>
          <option value="5">Equipo 5</option>
          <option value="6">Equipo 6</option>
          <option value="7">Equipo 7</option>
          <option value="8">Equipo 8</option>
        </select>
      </div>
      <div class="page1-form-group">
        <label for="">Turnos</label>
        <input name="turns" type="text" value="6" required disabled>
      </div>
      <div class="page1-form-group">
        <label for="">Tiempo por turno</label>
        <input name="time" type="text" value="150" required>
      </div>
      <div class="page1-form-group">
        <label for="">Delay</label>
        <input name="delay" type="text" value="1" required>
      </div>
      <div class="page1-form-group">
        <button type="submit">Play match!</button>
      </div>
    </form>
  </div>

  <div class="page page2" id="page2" hidden>
    <div class="score">
      <div class="team1-score-name team-score-name" id="team1-name">Orkadianoz</div>
      <div class="teams-scoreboard">
        <span id="team1-scoreboard">0</span>
        <span>–</span>
        <span id="team2-scoreboard">0</span>
      </div>
      <div class="team2-score-name team-score-name" id="team2-name">Angry Stitches</div>
    </div>
    <button class="team-turn team1-turn" id="team1-turn" onclick="turnForTeam1()">
      <img src="team1.jpeg" id="team1-logo" class="team-logo" alt="" width="100%">
      <div class="team-turn-content">
        <div class="team-turn-time" id="team1-turn-time">Empezar</div>
      </div>
      <div class="team-turn-turn">Turno: <span id="team1-turn-turn">0</span></div>
    </button>
    <button class="team-turn team2-turn" id="team1-turn" onclick="turnForTeam2()">
      <img src="team2.jpeg" id="team2-logo" class="team-logo" alt="" width="100%">
      <div class="team-turn-content">
        <div class="team-turn-time" id="team2-turn-time">Empezar</div>
      </div>
      <div class="team-turn-turn">Turno: <span id="team2-turn-turn">0</span></div>
    </button>
    <div class="pause-turn-container" id="pause-turn-container" hidden>
      <button class="pause-turn" onclick="showPage3()">Pause</button>
    </div>
  </div>

  <div class="page page3" id="page3" hidden>
    <div class="paused">Pausado</div>
    <div class="teams-score">
      <label for="team1-score" id="team1-score-name">Equipo 1</label>
      <select name="team1-score" id="team1-score-input">
        <option value="0">0 TD</option>
        <option value="1">1 TD</option>
        <option value="2">2 TD</option>
        <option value="3">3 TD</option>
        <option value="4">4 TD</option>
        <option value="5">5 TD</option>
        <option value="6">6 TD</option>
        <option value="7">7 TD</option>
        <option value="8">8 TD</option>
        <option value="9">9 TD</option>
        <option value="10">10 TD</option>
      </select>
      <label for="team2-score" id="team2-score-name">Equipo 2</label>
      <select name="team2-score" id="team2-score-input">
        <option value="0">0 TD</option>
        <option value="1">1 TD</option>
        <option value="2">2 TD</option>
        <option value="3">3 TD</option>
        <option value="4">4 TD</option>
        <option value="5">5 TD</option>
        <option value="6">6 TD</option>
        <option value="7">7 TD</option>
        <option value="8">8 TD</option>
        <option value="9">9 TD</option>
        <option value="10">10 TD</option>
      </select>
    </div>
    <div>
      <button onclick="keepGoing()">Continue</button>
      <button onclick="reset()">New Game</button>
    </div>
  </div>

  <div class="delay-container" id="delay-container" hidden>
    <div class="delay" id="elapsedDelay">Prepárate!</div>
  </div>

  <script>

    // state

    const pages = [
      document.querySelector('#page1'),
      document.querySelector('#page2'),
      document.querySelector('#page3'),
    ];

    const teams = [
      {
        id: 0,
        name: 'BB team',
        logo: 'team0.png',
      },
      {
        id: 1,
        name: 'Orkadianoz',
        logo: 'team1.jpeg',
      },
      {
        id: 2,
        name: 'Koalaz',
        logo: 'team2.jpeg',
      },
      {
        id: 3,
        name: 'Equipo 3',
        logo: 'team3.jpeg',
      },
      {
        id: 4,
        name: 'Equipo 4',
        logo: 'team4.jpeg',
      },
      {
        id: 5,
        name: 'Equipo 5',
        logo: 'team5.jpeg',
      },
      {
        id: 6,
        name: 'Equipo 6',
        logo: 'team6.jpeg',
      },
      {
        id: 7,
        name: 'Equipo 7',
        logo: 'team7.jpeg',
      },
      {
        id: 8,
        name: 'Equipo 8',
        logo: 'team8.jpeg',
      },
    ]

    let gameConfig;
    let gameState = {
      hasStarted: false,
      isPaused: false,
      team1: {
        turn: 0,
        elapsedTime: 0,
      },
      team2: {
        turn: 0,
        elapsedTime: 0
      },
      isTeam1turn: false
    }
    let clock;

    // functions

    function init() {
      const urlSearchParams = new URLSearchParams(window.location.search);
      const params = Object.fromEntries(urlSearchParams.entries());
      gameConfig = params;

      if (params?.team1 !== null && params?.team1 !== undefined) {
        showPage2()
        initClock(params)
      } else {
        showPage1()
      }
    }

    function showPage1() {
      pages[0].removeAttribute('hidden')
      pages[1].setAttribute('hidden', true)
      pages[2].setAttribute('hidden', true)
    }

    function showPage2() {
      pages[0].setAttribute('hidden', true)
      pages[1].removeAttribute('hidden')
      pages[2].setAttribute('hidden', true)
    }

    function showPage3() {
      pauseClock()
      pages[0].setAttribute('hidden', true)
      // pages[1].setAttribute('hidden', true)
      pages[2].removeAttribute('hidden')
    }

    function reset(){
      window.location.href = '/'
    }

    function keepGoing() {
      setTouchdowns()
      startClock()
      pages[2].setAttribute('hidden', true)
    }

    function turnForTeam1() {
      if (!gameState.hasStarted || !gameState.isTeam1turn) {
        if (!gameState.hasStarted) {
          gameState.hasStarted = true
          startGame()
        } else {
          restartClock()
        }
        gameState.isTeam1turn = true
        gameState.team1.turn += 1
        gameState.team1.elapsedTime = 0
        document.querySelector('#team1-turn-turn').innerHTML = gameState.team1.turn
      }
    }
    function turnForTeam2() {
      if (!gameState.hasStarted || gameState.isTeam1turn) {
        if (!gameState.hasStarted) {
          gameState.hasStarted = true
          startGame()
        } else {
          restartClock()
        }
        gameState.isTeam1turn = false
        gameState.team2.turn += 1
        gameState.team2.elapsedTime = 0
        document.querySelector('#team2-turn-turn').innerHTML = gameState.team2.turn
      }
    }

    function initClock(params) {
      initTeam1(params.team1)
      initTeam2(params.team2)
    }

    function startGame() {
      document.querySelector('#pause-turn-container').removeAttribute('hidden')
      startClock()
    }

    function initTeam1(id) {
      const team = teams.find(a => a.id === Number(id))
      const logoNode = document.querySelector('#team1-logo')
      const nameNode = document.querySelector('#team1-name')
      const teamScoreNode = document.querySelector('#team1-score-name')
      const teamScoreInputNode = document.querySelector('#team1-score-input')
      logoNode.src = team.logo
      nameNode.innerHTML = team.name
      teamScoreNode.innerHTML = team.name
      teamScoreInputNode.value = '0'
    }

    function initTeam2(id) {
      const team = teams.find(a => a.id === Number(id))
      const logoNode = document.querySelector('#team2-logo')
      const nameNode = document.querySelector('#team2-name')
      const teamScoreNode = document.querySelector('#team2-score-name')
      const teamScoreInputNode = document.querySelector('#team2-score-input')
      logoNode.src = team.logo
      nameNode.innerHTML = team.name
      teamScoreNode.innerHTML = team.name
      teamScoreInputNode.value = '0'
    }

    function applyClockLogic(timeDiff) {
      const team1Time = document.querySelector('#team1-turn-time')
      const team2Time = document.querySelector('#team2-turn-time')
      const remainingTime = Number(gameConfig.time * 1000) - Number(timeDiff)
      if (remainingTime < 0) {
        // TODO - NEXT TURN - THROW A WARNING
        pauseClock()
      } else {
        const remainingTimeInString = `${getRawMinutes(remainingTime)}:${getRawSeconds(remainingTime)}`
        if (gameState.isTeam1turn) {
          team1Time.innerHTML = remainingTimeInString
        } else {
          team2Time.innerHTML = remainingTimeInString
        }
      }
    }

    function setTouchdowns() {
      const team1ScoreInputNode = document.querySelector('#team1-score-input')
      const team2ScoreInputNode = document.querySelector('#team2-score-input')
      document.querySelector("#team1-scoreboard").innerHTML = team1ScoreInputNode.value
      document.querySelector("#team2-scoreboard").innerHTML = team2ScoreInputNode.value
    }

    // clock

    let startTime;
    let repaintLoop;
    let storedElapsedTime = 0;
    let now;

    function startClock() {
      console.log('start clock')
      triggerDelay().then(() => {
        console.log('start clock - timeout')
        startTime = performance.now()
        repaintLoop = requestAnimationFrame(tickClock)
      })
    }

    function pauseClock() {
      console.log('pause clock')
      storedElapsedTime = (now - startTime) + storedElapsedTime;
      cancelAnimationFrame(repaintLoop)
    }

    function tickClock() {
      console.log('tick clock')
      now = performance.now()
      const timeDiff = (now - startTime) + storedElapsedTime || 0;
      applyClockLogic(timeDiff)
      repaintLoop = requestAnimationFrame(tickClock)
    }

    function restartClock() {
      console.log('restart clock')
      startTime = null
      storedElapsedTime = null
      startTime = performance.now();
      cancelAnimationFrame(repaintLoop)
      startClock()
    }

    function getRawMinutes(duration) {
      const minutes = Math.round((duration / (1000 * 60)) % 60);
      const abs = Math.round(duration / (1000 * 60))
      const under10 = `0${minutes}`;
      const over10 = `${minutes}`;
      if (abs === 0) {
        return '00'
      } else {
        return `${(minutes < 10) ? under10 : over10}`
      }
    }
    function getRawSeconds(duration) {
      const seconds = Math.round((duration / 1000) % 60);
      const abs = Math.round(duration / 1000)
      const under10 = `0${seconds}`;
      const over10 = `${seconds}`;
      if (abs === 0) {
        return '00'
      } else {
        return `${(seconds < 10) ? under10 : over10}`
      }
    }
    function getRawMilliseconds(duration) {
      const milliseconds = Math.round((duration % 1000));
      return `${milliseconds}`
    }

    function triggerDelay() {
      return new Promise((resolve, reject) => {
        const delayContainerNode = document.querySelector('#delay-container')
        delayContainerNode.removeAttribute('hidden')
        setTimeout(() => {
          delayContainerNode.setAttribute('hidden', true)
          resolve()
        }, Number(gameConfig.delay) * 1000)
      })
    }

    // init

    init();

  </script>

</body>
</html>